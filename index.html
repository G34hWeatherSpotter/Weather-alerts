<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weather Alerts Revamp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body.dark-mode {
      background: #18191a;
      color: #d7dae0;
    }
    .card.dark-mode, .list-group-item.dark-mode {
      background: #242526;
      color: #d7dae0;
    }
    .leaflet-container {
      height: 400px;
      width: 100%;
      margin-bottom: 2rem;
    }
    .alert-legend {
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }
    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); }
    .social-links a { color: #fff; margin-left: 0.9rem; text-decoration: none; }
    .severe-banner { display: none; }
    .severe-banner.show { display: block; }
    #twitterSidebar {
      max-width: 350px;
      min-width: 250px;
      margin-left: 2rem;
    }
    @media (max-width: 992px) {
      #twitterSidebar { display: none; }
    }
    .self-destruct-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 9999;
      font-size: 1.1rem;
      border-radius: 50px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 #dc3545; }
      70% { box-shadow: 0 0 0 10px rgba(220,53,69,0.2); }
      100% { box-shadow: 0 0 0 0 #dc3545; }
    }
    .boom-bg {
      background: url('https://media.giphy.com/media/oe33xf3B50fsc/giphy.gif') center center / cover no-repeat !important;
      color: #fff !important;
    }
    .boom-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.88);
      z-index: 99999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: #fff;
      animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both;
    }
    @keyframes shake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-4px); }
      40%, 60% { transform: translateX(4px); }
    }
    .boom-btn { font-size: 1.1rem; margin-top: 2rem; }

    /* Simple legend color chips */
    .chip { display:inline-block; width:18px; height:12px; margin-right:6px; vertical-align:middle; border-radius:2px; }

    /* Update banner styles */
    #updateBanner { display: none; z-index: 1200; }
    #updateBanner.show { display: block; }
    #updateBanner .content { font-weight: 600; }
    .admin-edit { font-size: .9rem; margin-left: .6rem; text-decoration: underline; cursor: pointer; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3">
    <div class="container">
      <a class="navbar-brand" href="#">Weather Alerts</a>
      <div class="social-links ms-auto me-3">
        <a id="igLink" href="https://instagram.com/castrofunkywx" target="_blank" rel="noopener" aria-label="Instagram">@castrofunkywx</a>
        <a href="#" id="linkA" aria-label="Link A">Link A</a>
        <a href="#" id="linkB" aria-label="Link B">Link B</a>
      </div>
      <button class="btn btn-outline-light ms-2" id="darkToggle" aria-label="Toggle dark mode">ðŸŒ™</button>
    </div>
  </nav>

  <!-- Update banner controlled via localStorage (admin-edit opens prompt) -->
  <div id="updateBanner" class="alert alert-info text-dark text-center mx-3" role="region" aria-live="polite">
    <div class="d-flex justify-content-between align-items-center">
      <div class="content" id="updateBannerContent">Site updates and important information will appear here.</div>
      <div>
        <button class="btn btn-sm btn-light me-2" id="announceUpdateBtn" title="Announce update to users">Announce</button>
        <span class="admin-edit text-white" id="editUpdate">Edit</span>
        <button class="btn btn-sm btn-outline-dark ms-2" id="dismissUpdate">Dismiss</button>
      </div>
    </div>
  </div>

  <div id="severeBanner" class="alert alert-danger text-white severe-banner mx-3" role="region" aria-live="polite">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <strong>Severe Alerts Active:</strong>
        <ul id="severeList" class="mb-0"></ul>
      </div>
      <div>
        <button id="dismissSevere" class="btn btn-sm btn-light ms-3">Dismiss</button>
      </div>
    </div>
  </div>

  <main class="container-fluid">
    <div class="row">
      <div class="col-lg-9">
        <section class="mb-3">
          <div class="row align-items-center">
            <div class="col-md-3 mb-2">
              <button class="btn btn-secondary w-100" id="locateMe">Show Alerts For My Location</button>
            </div>
            <div class="col-md-3 mb-2">
              <input class="form-control" id="searchBox" placeholder="Search alerts... (e.g. hail, tornado)" aria-label="Search alerts"/>
            </div>
            <div class="col-md-3 mb-2">
              <select class="form-select" id="severityFilter" aria-label="Filter by severity">
                <option value="">All Severities</option>
                <option value="Warning">Warning</option>
                <option value="Watch">Watch</option>
                <option value="Advisory">Advisory</option>
              </select>
            </div>
            <div class="col-md-3 mb-2">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary" id="radarToggle">Toggle Radar</button>
                <button class="btn btn-outline-secondary mt-1" id="trackToggle">Toggle Tracks</button>
              </div>
            </div>
          </div>
        </section>

        <section>
          <div id="alert-map" class="mb-3" aria-label="Map of active alerts"></div>
          <div class="alert-legend">
            <span class="badge bg-danger">Warning</span>
            <span class="badge bg-warning text-dark">Watch</span>
            <span class="badge bg-info text-dark">Advisory</span>
            &nbsp;&nbsp;
            <span class="chip" style="background:#E31A1C;"></span> <small>Cat1+ / Hurricane (red)</small>
            &nbsp;&nbsp;
            <span class="chip" style="background:#FD8D3C;"></span> <small>Tropical Storm (orange)</small>
            &nbsp;&nbsp;
            <span class="chip" style="background:#3182bd;"></span> <small>Tropical Depression (blue)</small>
          </div>

          <div id="alerts" class="row g-3"></div>
        </section>
      </div>

      <aside class="col-lg-3" id="twitterSidebar">
        <h5 class="mb-2 fw-bold"><span style="color:#1DA1F2;">@NHC_Atlantic</span> Twitter Feed</h5>
        <a class="twitter-timeline" data-width="300" data-height="600" data-theme="dark" href="https://twitter.com/NHC_Atlantic?ref_src=twsrc%5Etfw">Tweets by NHC_Atlantic</a>
      </aside>
    </div>
  </main>

  <footer class="text-center text-muted py-4">
    &copy; 2025 Weather Alerts. Powered by <a href="https://weather.gov" target="_blank" rel="noopener">NOAA/NWS</a>.
  </footer>

  <button class="btn btn-danger self-destruct-btn" id="boomBtn" title="Self-Destruct">ðŸ’¥ Self-Destruct</button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  <script>
    // --- Config / palette (plain colors) ---
    const PLAIN_COLORS = {
      HURRICANE: '#E31A1C', // Cat1+ red
      TROPICAL_STORM: '#FD8D3C', // orange
      DEPRESSION: '#3182bd' // blue
    };

    // Alert severity plain colors
    const ALERT_PLAIN = {
      'Warning': PLAIN_COLORS.HURRICANE,
      'Watch': PLAIN_COLORS.TROPICAL_STORM,
      'Advisory': PLAIN_COLORS.DEPRESSION
    };

    // Helper: color by wind speed (returns hex)
    function stormColorFromWind(maxWind) {
      const w = parseInt(maxWind) || 0;
      if (w >= 74) return PLAIN_COLORS.HURRICANE;
      if (w >= 39) return PLAIN_COLORS.TROPICAL_STORM;
      if (w > 0) return PLAIN_COLORS.DEPRESSION;
      return '#7a4ea6'; // unknown / purple
    }

    // Utility: pick readable text color for a chip (simple rule)
    function textColorForChip(hex) {
      // quick luminance estimate for contrast; return black for bright/orange-like, white otherwise
      const c = hex.replace('#','');
      const r = parseInt(c.substring(0,2),16), g = parseInt(c.substring(2,4),16), b = parseInt(c.substring(4,6),16);
      const luminance = (0.299*r + 0.587*g + 0.114*b);
      return luminance > 150 ? '#000' : '#fff';
    }

    // --- Social links config ---
    const SOCIAL = {
      instagram: 'https://instagram.com/castrofunkywx',
      linkA: '#',
      linkB: '#'
    };
    document.getElementById('igLink').href = SOCIAL.instagram;
    document.getElementById('linkA').href = SOCIAL.linkA;
    document.getElementById('linkB').href = SOCIAL.linkB;

    // Dark mode toggle
    document.getElementById('darkToggle').onclick = () => {
      document.body.classList.toggle('dark-mode');
      document.querySelectorAll('.card, .list-group-item').forEach(e => e.classList.toggle('dark-mode'));
    };

    // Map setup
    const map = L.map('alert-map').setView([29, -75], 4);

    // Create dedicated panes so alerts and hurricane overlays render above radar tiles
    map.createPane('hurricanePane');
    map.getPane('hurricanePane').style.zIndex = 650;

    map.createPane('alertsPane');
    // alerts should render above radar and other layers
    map.getPane('alertsPane').style.zIndex = 700;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Radar WMS layer
    let radarLayer = null;
    const radarURL = 'https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows?';
    function addRadarLayer() {
      if (!radarLayer) {
        radarLayer = L.tileLayer.wms(radarURL, {
          layers: 'conus_bref_qcd',
          format: 'image/png',
          transparent: true,
          opacity: 0.6,
          attribution: "NOAA/NWS NEXRAD"
        }).addTo(map);
        // ensure radar is below alerts/hurricane panes
        map.getPane('hurricanePane').style.zIndex = 650;
        map.getPane('alertsPane').style.zIndex = 700;
      }
    }
    function removeRadarLayer() {
      if (radarLayer) { map.removeLayer(radarLayer); radarLayer = null; }
    }
    let radarEnabled = true;
    addRadarLayer();

    document.getElementById('radarToggle').onclick = () => {
      radarEnabled = !radarEnabled;
      if (radarEnabled) addRadarLayer(); else removeRadarLayer();
    };

    // Hurricane overlay layer group placed into the hurricanePane
    const hurricaneLayer = L.layerGroup([], { pane: 'hurricanePane' }).addTo(map);
    let tracksEnabled = true;
    document.getElementById('trackToggle').onclick = () => {
      tracksEnabled = !tracksEnabled;
      if (tracksEnabled) map.addLayer(hurricaneLayer); else map.removeLayer(hurricaneLayer);
    };

    // Alerts logic
    let allAlerts = [];
    let markers = [];
    let userLocation = null;
    let previousSevereIds = new Set();

    const severeBannerEl = document.getElementById('severeBanner');
    const severeListEl = document.getElementById('severeList');
    document.getElementById('dismissSevere').onclick = () => severeBannerEl.classList.remove('show');

    if ('Notification' in window && Notification.permission === 'default') {
      try { Notification.requestPermission(); } catch (e) { /* ignore */ }
    }

    async function fetchAlerts() {
      try {
        const resp = await fetch('https://api.weather.gov/alerts/active');
        const data = await resp.json();
        allAlerts = data.features || [];
        handleSevereAlerts(allAlerts);
        renderAlerts();
      } catch (e) {
        document.getElementById('alerts').innerHTML = '<div class="col-12"><div class="alert alert-danger">Could not load alerts.</div></div>';
      }
    }

    function handleSevereAlerts(alerts) {
      const severe = alerts.filter(a => (a.properties && a.properties.severity) === 'Warning');
      severeListEl.innerHTML = '';
      if (severe.length) {
        severe.forEach(a => {
          const li = document.createElement('li');
          const headline = a.properties && (a.properties.headline || a.properties.event || 'Severe Alert');
          const href = (a.properties && a.properties.web) || '#';
          const link = document.createElement('a');
          link.href = href; link.target = '_blank'; link.rel = 'noopener'; link.textContent = headline;
          li.appendChild(link); severeListEl.appendChild(li);
        });
        severeBannerEl.classList.add('show');
      } else {
        severeBannerEl.classList.remove('show');
      }

      try {
        if ('Notification' in window && Notification.permission === 'granted') {
          severe.forEach(a => {
            const id = a.id || JSON.stringify(a.properties || {});
            if (!previousSevereIds.has(id)) {
              const title = (a.properties && (a.properties.headline || a.properties.event)) || 'Severe Alert';
              const body = (a.properties && (a.properties.description || a.properties.instruction)) || '';
              new Notification(title, { body: body, silent: true });
            }
          });
        }
      } catch (e) { console.warn('Notification error', e); }
      previousSevereIds = new Set(severe.map(a => a.id || JSON.stringify(a.properties || {})));
    }

    function renderAlerts() {
      let filtered = allAlerts;
      const searchVal = document.getElementById('searchBox').value.trim().toLowerCase();
      if (searchVal) {
        filtered = filtered.filter(alert =>
          (alert.properties.headline || '').toLowerCase().includes(searchVal) ||
          (alert.properties.description || '').toLowerCase().includes(searchVal)
        );
      }
      const sev = document.getElementById('severityFilter').value;
      if (sev) filtered = filtered.filter(a => a.properties.severity === sev);

      const alertsDiv = document.getElementById('alerts');
      alertsDiv.innerHTML = '';
      if (!filtered.length) {
        alertsDiv.innerHTML = '<div class="col-12"><div class="alert alert-secondary">No alerts found.</div></div>';
      }
      filtered.forEach(alert => {
        const p = alert.properties || {};
        const sevLabel = p.severity || 'Advisory';
        const bootClass = (sevLabel === 'Warning') ? 'danger' : (sevLabel === 'Watch' ? 'warning' : 'info');
        const color = ALERT_PLAIN[sevLabel] || '#777';
        const badgeTextColor = textColorForChip(color);
        alertsDiv.innerHTML += `
          <div class="col-md-6 col-lg-4">
            <div class="card border-${bootClass} h-100">
              <div class="card-header text-white fw-bold" style="background:${color};" tabindex="0">${p.headline || 'Weather Alert'}</div>
              <div class="card-body">
                <p class="card-text"><strong>Area:</strong> ${p.areaDesc||'N/A'}</p>
                <p class="card-text"><strong>Severity:</strong> <span class="badge" style="background:${color}; color:${badgeTextColor}">${sevLabel}</span></p>
                <p class="card-text"><strong>Start:</strong> ${p.onset ? new Date(p.onset).toLocaleString() : 'N/A'}</p>
                <p class="card-text"><strong>End:</strong> ${p.expires ? new Date(p.expires).toLocaleString() : 'N/A'}</p>
                <details><summary>Details</summary><div class="small">${p.description||''}</div></details>
              </div>
            </div>
          </div>`;
      });

      // map markers/polygons
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      filtered.forEach(alert => {
        const geo = alert.geometry; if (!geo) return;
        const sevLabel = (alert.properties && alert.properties.severity) || 'Advisory';
        const color = ALERT_PLAIN[sevLabel] || '#777';
        const paneOpts = { pane: 'alertsPane' };
        if (geo.type === 'Point') {
          const [lon, lat] = geo.coordinates;
          const marker = L.circleMarker([lat, lon], { radius:8, color: color, fillColor: color, fillOpacity: 0.9, pane: 'alertsPane' }).addTo(map)
            .bindPopup(`<b>${alert.properties.headline||'Alert'}</b><br>${alert.properties.areaDesc||''}`);
          markers.push(marker);
        }
        if (geo.type === 'Polygon') {
          // GeoJSON polygons are array of linear rings
          const latlngs = geo.coordinates.map(ring => ring.map(([lon, lat]) => [lat, lon]));
          const poly = L.polygon(latlngs, { color: color, fillColor: color, fillOpacity: 0.22, weight: 2, pane: 'alertsPane' }).addTo(map);
          markers.push(poly);
        }
        if (geo.type === 'MultiPolygon') {
          geo.coordinates.forEach(polygon => {
            const latlngs = polygon.map(ring => ring.map(([lon, lat]) => [lat, lon]));
            const poly = L.polygon(latlngs, { color: color, fillColor: color, fillOpacity: 0.22, weight: 2, pane: 'alertsPane' }).addTo(map);
            markers.push(poly);
          });
        }
      });

      // keep hurricane overlays updated as well
      renderHurricaneTracks();
    }

    document.getElementById('searchBox').addEventListener('input', renderAlerts);
    document.getElementById('severityFilter').addEventListener('change', renderAlerts);

    document.getElementById('locateMe').onclick = () => {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          map.setView([pos.coords.latitude, pos.coords.longitude], 8);
        }, () => alert('Could not get your location.'));
      } else alert('Geolocation not supported.');
    };

    // --- Hurricane tracks (NHC) ---
    let hurricaneData = null;
    async function fetchHurricaneTracks() {
      try {
        const url = 'https://www.nhc.noaa.gov/CurrentStorms.json';
        const resp = await fetch(url);
        hurricaneData = await resp.json();
        renderHurricaneTracks();
      } catch (e) {
        hurricaneData = null;
        console.warn('Could not fetch NHC data', e);
      }
    }

    function renderHurricaneTracks() {
      // clear prior overlays
      hurricaneLayer.clearLayers();
      if (!hurricaneData || !Array.isArray(hurricaneData.activeStorms)) return;

      hurricaneData.activeStorms.forEach(storm => {
        const color = stormColorFromWind(storm.maxWind);

        // Forecast cone polygons (use hurricanePane)
        if (storm.forecastCone && storm.forecastCone.coordinates) {
          storm.forecastCone.coordinates.forEach(ring => {
            const latlngs = ring.map(([lon, lat]) => [lat, lon]);
            const cone = L.polygon(latlngs, {
              pane: 'hurricanePane',
              color: color,
              fillColor: color,
              fillOpacity: 0.12,
              weight: 2,
              dashArray: '6'
            });
            cone.bindPopup(`<b>${storm.stormName || 'Storm'} Forecast Cone</b><br>Max Wind: ${storm.maxWind || 'N/A'} mph`);
            hurricaneLayer.addLayer(cone);
          });
        }

        // Forecast track polyline
        if (storm.forecastTrack && Array.isArray(storm.forecastTrack.coordinates) && storm.forecastTrack.coordinates.length) {
          const trackLatLngs = storm.forecastTrack.coordinates.map(([lon, lat]) => [lat, lon]);
          const trackLine = L.polyline(trackLatLngs, {
            pane: 'hurricanePane',
            color: color,
            weight: 3,
            opacity: 0.95
          });
          trackLine.bindPopup(`<b>${storm.stormName || 'Track'}</b><br>Max Wind: ${storm.maxWind || 'N/A'} mph`);
          hurricaneLayer.addLayer(trackLine);
        }

        // Track points
        if (storm.forecastTrack && Array.isArray(storm.forecastTrack.coordinates)) {
          storm.forecastTrack.coordinates.forEach(([lon, lat], i) => {
            const point = L.circleMarker([lat, lon], {
              pane: 'hurricanePane',
              radius: 6,
              color: '#ffffff',
              weight: 1,
              fillColor: color,
              fillOpacity: 0.95
            });
            let popup = `<b>${storm.stormName || 'Tropical Cyclone'}</b>`;
            if (storm.stormType) popup += `<br>Type: ${storm.stormType}`;
            if (storm.maxWind) popup += `<br>Max Wind: ${storm.maxWind} mph`;
            if (storm.forecastTrackTimes && storm.forecastTrackTimes[i]) popup += `<br>Time: ${storm.forecastTrackTimes[i]}`;
            if (storm.publicAdvisory) popup += `<br><a href="${storm.publicAdvisory}" target="_blank">Full Advisory</a>`;
            point.bindPopup(popup);
            hurricaneLayer.addLayer(point);
          });
        }
      });

      // ensure hurricane pane stays above radar layer
      map.getPane('hurricanePane').style.zIndex = 650;
    }

    // initial loads
    fetchAlerts();
    fetchHurricaneTracks();

    // refresh intervals
    setInterval(fetchAlerts, 60000);
    setInterval(fetchHurricaneTracks, 60000);

    // --- Update banner controls ---
    const updateBanner = document.getElementById('updateBanner');
    const updateBannerContent = document.getElementById('updateBannerContent');
    const editUpdate = document.getElementById('editUpdate');
    const dismissUpdate = document.getElementById('dismissUpdate');
    const announceUpdateBtn = document.getElementById('announceUpdateBtn');

    function loadUpdateBanner() {
      const msg = localStorage.getItem('siteUpdateMessage') || '';
      if (msg && msg.trim().length) {
        updateBannerContent.textContent = msg;
        updateBanner.classList.add('show');
      } else {
        updateBanner.classList.remove('show');
      }
    }

    editUpdate.addEventListener('click', () => {
      const current = localStorage.getItem('siteUpdateMessage') || '';
      const txt = prompt('Edit site update message (leave blank to clear):', current);
      if (txt === null) return;
      localStorage.setItem('siteUpdateMessage', txt);
      loadUpdateBanner();
    });

    dismissUpdate.addEventListener('click', () => {
      updateBanner.classList.remove('show');
    });

    announceUpdateBtn.addEventListener('click', () => {
      const msg = localStorage.getItem('siteUpdateMessage') || updateBannerContent.textContent || 'Update posted.';
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Site update', { body: msg, silent: false });
      } else if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(p => {
          if (p === 'granted') new Notification('Site update', { body: msg });
        });
      } else {
        alert(msg);
      }
    });

    loadUpdateBanner();

    // --- Self-destruct button (client-only) ---
    document.getElementById('boomBtn').onclick = function() {
      document.body.classList.add('boom-bg');
      const overlay = document.createElement('div');
      overlay.className = 'boom-overlay';
      overlay.innerHTML = `
        <div>ðŸ’¥ <b>Self-Destruct Sequence</b> ðŸ’¥</div>
        <div style="font-size:1.4rem;margin:1rem 0;">Website destroyed.<br>Refresh page to restore!</div>
        <button class="btn btn-light boom-btn" onclick="window.location.reload()">Repair (Reload)</button>
        <div style="font-size:2.5rem;">ðŸ”¥</div>
        <audio autoplay>
          <source src="https://cdn.pixabay.com/audio/2022/10/16/audio_12a8b7d1d3.mp3" type="audio/mpeg">
        </audio>
      `;
      document.body.innerHTML = '';
      document.body.appendChild(overlay);
    };
  </script>
  <!--
    NWS Radar attribution:
    Radar mosaic tiles via https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows
    See https://opengeo.ncep.noaa.gov/geoserver/web/ for details.
    Hurricane forecast cone/tracks via NHC: https://www.nhc.noaa.gov/
  -->
</body>
</html>
